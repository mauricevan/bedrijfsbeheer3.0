// Bedrijfsbeheer 3.0 Database Schema
// PostgreSQL + Prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management
// ============================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String
  isAdmin      Boolean  @default(false) @map("is_admin")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  quotes       Quote[]
  invoices     Invoice[]
  workOrders   WorkOrder[]

  @@map("users")
}

// ============================================
// Customers & CRM
// ============================================

model Customer {
  id              String    @id @default(uuid())
  name            String
  email           String?
  phone           String?
  address         String?
  city            String?
  postalCode      String?   @map("postal_code")
  country         String?   @default("Nederland")
  kvkNumber       String?   @map("kvk_number")
  vatNumber       String?   @map("vat_number")

  // CRM fields
  status          String    @default("active") // active, inactive, lead
  source          String?   // referral, website, cold_call, etc.
  notes           String?
  lastContactDate DateTime? @map("last_contact_date")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  quotes          Quote[]
  invoices        Invoice[]
  workOrders      WorkOrder[]

  @@index([email])
  @@index([status])
  @@map("customers")
}

// ============================================
// Quotes (Offertes)
// ============================================

model Quote {
  id          String   @id
  customerId  String   @map("customer_id")
  userId      String   @map("user_id")
  status      String   @default("draft") // draft, sent, approved, rejected
  subtotal    Decimal  @db.Decimal(10, 2)
  vatRate     Decimal  @db.Decimal(5, 2) @map("vat_rate")
  vatAmount   Decimal  @db.Decimal(10, 2) @map("vat_amount")
  total       Decimal  @db.Decimal(10, 2)
  notes       String?
  validUntil  String?  @map("valid_until")
  workOrderId String?  @unique @map("work_order_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user        User       @relation(fields: [userId], references: [id])
  customer    Customer   @relation(fields: [customerId], references: [id])
  workOrder   WorkOrder? @relation(fields: [workOrderId], references: [id])
  items       QuoteItem[]

  @@index([customerId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("quotes")
}

model QuoteItem {
  id              String  @id @default(uuid())
  quoteId         String  @map("quote_id")
  inventoryItemId String? @map("inventory_item_id")
  name            String
  description     String?
  quantity        Int
  unitPrice       Decimal @db.Decimal(10, 2) @map("unit_price")
  total           Decimal @db.Decimal(10, 2)

  quote           Quote          @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  inventoryItem   InventoryItem? @relation(fields: [inventoryItemId], references: [id])

  @@index([quoteId])
  @@map("quote_items")
}

// ============================================
// Work Orders (Werkbonnen)
// ============================================

model WorkOrder {
  id             String    @id
  title          String
  description    String?
  status         String    @default("todo") // todo, in_progress, completed, cancelled
  priority       String    @default("normal") // low, normal, high, urgent
  assignedTo     String    @map("assigned_to")
  assignedBy     String    @map("assigned_by")
  customerId     String    @map("customer_id")
  quoteId        String?   @unique @map("quote_id")
  invoiceId      String?   @unique @map("invoice_id")
  estimatedHours Int?      @map("estimated_hours")
  actualHours    Float?    @map("actual_hours")
  startedAt      DateTime? @map("started_at")
  completedAt    DateTime? @map("completed_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user           User                @relation(fields: [assignedTo], references: [id])
  customer       Customer            @relation(fields: [customerId], references: [id])
  quote          Quote?
  invoice        Invoice?
  materials      WorkOrderMaterial[]

  @@index([assignedTo])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@map("work_orders")
}

model WorkOrderMaterial {
  id              String  @id @default(uuid())
  workOrderId     String  @map("work_order_id")
  inventoryItemId String  @map("inventory_item_id")
  quantity        Int
  unitPrice       Decimal @db.Decimal(10, 2) @map("unit_price")

  workOrder       WorkOrder     @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])

  @@index([workOrderId])
  @@map("work_order_materials")
}

// ============================================
// Invoices (Facturen)
// ============================================

model Invoice {
  id             String    @id
  customerId     String    @map("customer_id")
  userId         String    @map("user_id")
  workOrderId    String?   @unique @map("work_order_id")
  status         String    @default("draft") // draft, sent, paid, overdue, cancelled
  subtotal       Decimal   @db.Decimal(10, 2)
  vatRate        Decimal   @db.Decimal(5, 2) @map("vat_rate")
  vatAmount      Decimal   @db.Decimal(10, 2) @map("vat_amount")
  total          Decimal   @db.Decimal(10, 2)
  amountPaid     Decimal   @default(0) @db.Decimal(10, 2) @map("amount_paid")
  dueDate        String    @map("due_date")
  paidDate       String?   @map("paid_date")
  paymentMethod  String?   @map("payment_method") // bank_transfer, cash, card, etc.
  notes          String?
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  user           User          @relation(fields: [userId], references: [id])
  customer       Customer      @relation(fields: [customerId], references: [id])
  workOrder      WorkOrder?    @relation(fields: [workOrderId], references: [id])
  items          InvoiceItem[]

  @@index([customerId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("invoices")
}

model InvoiceItem {
  id          String  @id @default(uuid())
  invoiceId   String  @map("invoice_id")
  name        String
  description String?
  quantity    Int
  unitPrice   Decimal @db.Decimal(10, 2) @map("unit_price")
  total       Decimal @db.Decimal(10, 2)

  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_items")
}

// ============================================
// Inventory Management
// ============================================

model InventoryItem {
  id           String   @id @default(uuid())
  productId    String   @unique @map("product_id")
  name         String
  description  String?
  category     String
  unit         String   @default("stuks") // stuks, meter, kg, etc.
  purchasePrice Decimal @db.Decimal(10, 2) @map("purchase_price")
  sellingPrice  Decimal @db.Decimal(10, 2) @map("selling_price")
  quantity     Int      @default(0)
  minStock     Int      @default(0) @map("min_stock")
  location     String?
  supplier     String?
  notes        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  quoteItems        QuoteItem[]
  workOrderMaterials WorkOrderMaterial[]

  @@index([category])
  @@index([productId])
  @@map("inventory_items")
}

// ============================================
// Employees & HRM
// ============================================

model Employee {
  id          String    @id @default(uuid())
  firstName   String    @map("first_name")
  lastName    String    @map("last_name")
  email       String    @unique
  phone       String?
  address     String?
  city        String?
  postalCode  String?   @map("postal_code")
  role        String    // technician, manager, admin, etc.
  department  String?
  hourlyRate  Decimal?  @db.Decimal(10, 2) @map("hourly_rate")
  hireDate    String    @map("hire_date")
  terminationDate String? @map("termination_date")
  status      String    @default("active") // active, inactive, on_leave
  notes       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([status])
  @@index([role])
  @@map("employees")
}

// ============================================
// Transactions & Bookkeeping
// ============================================

model Transaction {
  id          String   @id @default(uuid())
  date        String
  type        String   // income, expense
  category    String   // sales, purchase, salary, rent, etc.
  description String
  amount      Decimal  @db.Decimal(10, 2)
  invoiceId   String?  @map("invoice_id")
  paymentMethod String? @map("payment_method")
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([type])
  @@index([category])
  @@index([date])
  @@map("transactions")
}

// ============================================
// Audit Logging
// ============================================

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id")
  userName    String?  @map("user_name")
  action      String   // create, update, delete
  resource    String   // users, quotes, invoices, etc.
  resourceId  String   @map("resource_id")
  changes     String?  @db.Text // JSON string of changes
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([resource])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
